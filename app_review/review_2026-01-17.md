# Code Review Report

**Generated**: 2026-01-17T00:00:00Z
**Reviewed Work**: Stripe Membership Management System Implementation (Phases 1-4)
**Plan Reference**: specs/stripe/01-07 (7 spec files)
**Git Diff Summary**: 26 files changed, 2227 insertions(+), 454 deletions(-)
**Verdict**: ‚ö†Ô∏è FAIL

---

## Executive Summary

The Stripe membership management implementation follows the Effect-TS architecture well with proper service composition, tagged error handling, and clean separation of concerns. However, **one critical security issue** (hardcoded fallback QR signing secret) must be addressed before production deployment. The implementation also has several high-risk issues around authentication and data handling that should be fixed, plus medium-risk code quality concerns.

---

## Quick Reference

| #   | Description                                      | Risk Level | Recommended Solution                   |
| --- | ------------------------------------------------ | ---------- | -------------------------------------- |
| 1   | QR signing secret has hardcoded fallback         | BLOCKER    | Remove fallback, require env var       |
| 2   | Checkout endpoint lacks authentication           | HIGH       | Add session validation before checkout |
| 3   | Admin role verification relies solely on claims  | HIGH       | Add additional admin whitelist check   |
| 4   | `getActiveMembership` includes "canceled" status | HIGH       | Remove "canceled" from active query    |
| 5   | `sessionConfig` uses `any` type                  | MEDIUM     | Define proper Stripe types             |
| 6   | Missing Firestore rules for stats collection     | MEDIUM     | Add stats collection security rules    |
| 7   | Debug console.log in firestore.service.ts        | MEDIUM     | Remove or use Effect.log               |
| 8   | Empty string fallback for price IDs              | MEDIUM     | Validate env vars at startup           |
| 9   | User ID fallback to subscriptionId               | LOW        | Document this behavior, consider UUID  |
| 10  | Truncated HMAC signature (8 chars)               | LOW        | Consider longer signature for security |

---

## Issues by Risk Tier

### üö® BLOCKERS (Must Fix Before Merge)

#### Issue #1: QR Signing Secret Has Hardcoded Fallback

**Description**: The QR service uses a hardcoded fallback secret `"dec-membership-secret-2025"` when `QR_SIGNING_SECRET` environment variable is not set. This is a **critical security vulnerability** because:

1. The hardcoded secret is visible in source code
2. If deployed without the env var, all QR codes would use a known secret
3. Attackers could forge membership QR codes

**Location**:

- File: `src/lib/effect/qr.service.ts`
- Lines: `29`

**Offending Code**:

```typescript
const getSigningSecret = () => process.env.QR_SIGNING_SECRET || 'dec-membership-secret-2025';
```

**Recommended Solutions**:

1. **Fail Fast if Secret Not Configured** (Preferred)
   - Throw an error if `QR_SIGNING_SECRET` is not set
   - This ensures the service cannot start without proper configuration

   ```typescript
   const getSigningSecret = () => {
     const secret = process.env.QR_SIGNING_SECRET;
     if (!secret) {
       throw new Error('QR_SIGNING_SECRET environment variable is required');
     }
     return secret;
   };
   ```

   - Rationale: Prevents accidental deployment with weak security

2. **Return Effect.fail Instead of Fallback**
   - Wrap in Effect for consistent error handling
   - Trade-off: Requires callers to handle the error case

---

### ‚ö†Ô∏è HIGH RISK (Should Fix Before Merge)

#### Issue #2: Checkout Endpoint Lacks Authentication

**Description**: The `/api/checkout` endpoint accepts POST requests without requiring authentication. While it validates the request body and price ID, any unauthenticated user can create checkout sessions. This could be exploited for:

- Creating spam checkout sessions
- Potential abuse of Stripe rate limits
- Session enumeration attacks

**Location**:

- File: `app/api/checkout/route.ts`
- Lines: `9-68`

**Offending Code**:

```typescript
export async function POST(request: NextRequest) {
  // Parse request body
  const body = await request.json();
  // No authentication check here
  const program = pipe(
    S.decodeUnknown(CheckoutSessionRequest)(body),
    // ...
  );
}
```

**Recommended Solutions**:

1. **Add Optional Authentication Check** (Preferred)
   - Check for session cookie but don't require it (to allow guest checkout)
   - Log authenticated vs unauthenticated checkouts for monitoring
   - Add rate limiting for unauthenticated requests
   - Rationale: Balances security with user experience

2. **Require Authentication for All Checkouts**
   - Add session validation at the start
   - Trade-off: Blocks guest checkout flow

---

#### Issue #3: Admin Role Verification Relies Solely on Firebase Custom Claims

**Description**: Admin access is controlled entirely through Firebase custom claims. If an attacker compromises a Firebase token or if claims are misconfigured, they could gain admin access. There's no secondary verification layer.

**Location**:

- File: `src/lib/effect/admin.service.ts`
- Lines: `54-67`

**Offending Code**:

```typescript
verifyAdmin: (sessionCookie) =>
  pipe(
    auth.verifyAdminClaim(sessionCookie),
    Effect.flatMap((session) =>
      session.isAdmin
        ? Effect.succeed({ uid: session.uid, email: session.email })
        : Effect.fail(new UnauthorizedError({ message: "Admin access required" }))
    ),
  ),
```

**Recommended Solutions**:

1. **Add Admin Email Whitelist** (Preferred)
   - Maintain a list of allowed admin emails in environment variables
   - Verify both the claim AND email is in whitelist
   - Rationale: Defense in depth

2. **Add IP Allowlist for Admin Actions**
   - Only allow admin API calls from specific IP ranges
   - Trade-off: Limits admin mobility

---

#### Issue #4: `getActiveMembership` Query Includes "canceled" Status

**Description**: The `getActiveMembership` method queries for memberships with status "canceled" which is semantically incorrect. A canceled membership should not be considered "active". This appears to be debug code left in production.

**Location**:

- File: `src/lib/effect/firestore.service.ts`
- Lines: `219-226` and `261-263`

**Offending Code**:

```typescript
// Note: Also including "canceled" temporarily for debugging
const snapshot = await db
  .collection(COLLECTIONS.USERS)
  .doc(userId)
  .collection(COLLECTIONS.MEMBERSHIPS)
  .where('status', 'in', ['active', 'trialing', 'past_due', 'canceled']);
// ...
```

**Recommended Solutions**:

1. **Remove "canceled" from Active Query** (Preferred)
   - Change to: `["active", "trialing", "past_due"]`
   - Remove the debug comment
   - Rationale: Correct semantic behavior

---

### ‚ö° MEDIUM RISK (Fix Soon)

#### Issue #5: `sessionConfig` Uses `any` Type

**Description**: The checkout session configuration uses `any` type, bypassing TypeScript's type safety for Stripe API parameters.

**Location**:

- File: `src/lib/effect/stripe.service.ts`
- Lines: `106`

**Offending Code**:

```typescript
const sessionConfig: any = {
  mode: 'subscription',
  // ...
};
```

**Recommended Solutions**:

1. **Use Stripe.Checkout.SessionCreateParams Type**

   ```typescript
   const sessionConfig: Stripe.Checkout.SessionCreateParams = { ... };
   ```

   - Rationale: Type safety for Stripe API parameters

---

#### Issue #6: Missing Firestore Rules for Stats Collection

**Description**: The `firestore.rules` file doesn't include rules for the `stats` collection used by `StatsService`. This means the collection may have default deny rules, which is good, but should be explicitly defined.

**Location**:

- File: `firestore.rules`
- Lines: `1-58`

**Recommended Solutions**:

1. **Add Explicit Stats Collection Rules**

   ```javascript
   // Stats collection (Admin SDK only)
   match /stats/{docId} {
     allow read: if false;
     allow write: if false;
   }
   ```

---

#### Issue #7: Debug Logging in Production Code

**Description**: Multiple `console.log` statements exist in production code, including detailed membership debugging output. These should use Effect.log or be removed.

**Location**:

- File: `src/lib/effect/firestore.service.ts`
- Lines: `252-257`, `274`

**Offending Code**:

```typescript
console.log(`Found ${allMemberships.size} membership(s) for user ${userId}:`);
allMemberships.docs.forEach((doc) => {
  console.log(`  - ID: ${doc.id}, Status: ${doc.data().status}, ...`);
});
```

**Recommended Solutions**:

1. **Replace with Effect.log**
   - Use `yield* Effect.log(...)` for consistent logging
   - Or remove entirely if not needed
   - Rationale: Consistent logging infrastructure

---

#### Issue #8: Empty String Fallback for Price IDs

**Description**: The `PRICE_TO_PLAN` mapping uses empty string as a key when env vars are not set, which could cause unexpected behavior.

**Location**:

- File: `src/lib/effect/membership.service.ts`
- Lines: `22-25`

**Offending Code**:

```typescript
const PRICE_TO_PLAN: Record<string, 'individual' | 'family'> = {
  [process.env.STRIPE_PRICE_INDIVIDUAL || '']: 'individual',
  [process.env.STRIPE_PRICE_FAMILY || '']: 'family',
};
```

**Recommended Solutions**:

1. **Validate Environment Variables at Startup**
   - Add startup validation that fails if required env vars are missing
   - Rationale: Fail fast on misconfiguration

---

### üí° LOW RISK (Nice to Have)

#### Issue #9: User ID Fallback to Subscription ID

**Description**: When creating a user without a Firebase UID, the subscription ID is used as the user document ID. This is functional but creates inconsistent ID formats.

**Location**:

- File: `src/lib/effect/membership.service.ts`
- Lines: `183`

**Offending Code**:

```typescript
userDocId = existingUser?.id || subscriptionId; // Use subscription ID as fallback
```

**Recommended Solutions**:

1. **Document This Behavior**
   - Add a comment explaining the rationale
   - Consider generating a UUID instead for consistency

---

#### Issue #10: Truncated HMAC Signature

**Description**: The QR code HMAC signature is truncated to 8 characters. While this keeps QR codes compact, it reduces security margin.

**Location**:

- File: `src/lib/effect/qr.service.ts`
- Lines: `47-49`

**Offending Code**:

```typescript
const signature = crypto.createHmac('sha256', secret).update(dataToSign).digest('hex').slice(0, 8); // Truncate for compact QR
```

**Recommended Solutions**:

1. **Increase to 16 Characters**
   - Balances QR size with security
   - 16 hex chars = 64 bits of collision resistance

---

## Plan Compliance Check

Based on specs/stripe/01-07:

- [x] Effect-TS (`effect`, `@effect/schema`) packages installed
- [x] Tagged errors defined: `StripeError`, `FirestoreError`, `ValidationError`, `NotFoundError`
- [x] Effect Schema codecs defined for API request/response types
- [x] `StripeService` implemented with required methods
- [x] `FirestoreService` implemented with required methods
- [x] `MembershipService` orchestrates business logic
- [x] Layers composed with `Layer.provide()`
- [x] Webhook handler validates signature before processing
- [x] Idempotency handling for webhooks implemented
- [x] Session cookie management implemented
- [x] Admin portal with member search implemented
- [x] Digital membership cards with QR codes implemented
- [ ] QR signing secret requires env var (BLOCKER - has fallback)
- [x] Firestore security rules defined

---

## Verification Checklist

- [ ] All blockers addressed
- [ ] High-risk issues reviewed and resolved or accepted
- [ ] Breaking changes documented with migration guide
- [ ] Security vulnerabilities patched
- [ ] Performance regressions investigated
- [ ] Tests cover new functionality
- [ ] Documentation updated for API changes

---

## Final Verdict

**Status**: ‚ö†Ô∏è FAIL

**Reasoning**: The implementation is well-architected and follows the Effect-TS patterns correctly. However, **Issue #1 (hardcoded QR signing secret fallback)** is a critical security vulnerability that must be fixed before production deployment. The high-risk issues around authentication and the debug "canceled" status query should also be addressed.

**Next Steps**:

1. **CRITICAL**: Remove the hardcoded fallback in `qr.service.ts` and require `QR_SIGNING_SECRET` env var
2. **HIGH**: Remove "canceled" from the `getActiveMembership` query
3. **HIGH**: Consider adding authentication or rate limiting to the checkout endpoint
4. **MEDIUM**: Add missing Firestore rules for stats collection
5. **MEDIUM**: Replace `console.log` with `Effect.log` in firestore.service.ts
6. Run `pnpm tsc --noEmit` to verify TypeScript compilation
7. Run `pnpm build` to verify production build

---

**Report File**: `app_review/review_2026-01-17.md`
